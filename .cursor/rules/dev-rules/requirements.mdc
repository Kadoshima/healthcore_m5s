---
description: 
globs: 
alwaysApply: false
---
以下では、**M5StickC Plus 2**（以下M5モジュールと表記）を足首装着型センサとして使用し、「歩行ピッチ（BPM）の推定」と「スマートフォンへのBluetooth送信」に特化した要件を示します。**音提示やその制御ロジックはスマートフォン側**で実行し、M5モジュールは計測とデータ配信の役割に限定します。

---

# M5モジュール（足首装着）側：要件定義

## 1. 概要

- M5モジュールを足首に装着し、内蔵のIMUで加速度・ジャイロ情報を取得。  
- 取得した生データ、または簡易的に推定した歩行ピッチ（BPM）情報をリアルタイムでBLE通信し、スマートフォンに送信。  
- スマートフォン側では受信したデータをもとに詳細な解析を行い、音刺激やテンポ制御などを実施する。  

---

## 2. 機能要件

### 2.1. センサ計測機能

1. **加速度・ジャイロ計測（必須）**  
   - 内蔵IMU（MPU6886等）で3軸加速度と3軸ジャイロをサンプリング。  
   - サンプリングレート: 20～50Hz程度（歩行ピッチ推定に十分な周波数帯）。  
   - レンジ: ±2g～±4g（歩行時の足首加速度をカバー）。  
   - 足首に装着しても邪魔にならない形状・固定方法（バンドなど）を採用。

2. **歩行ピッチ推定（任意／簡易的）**  
   - M5モジュール側で簡易的なピーク検出などを行い、おおまかなBPMを計算する。  
   - スマートフォン側で詳細解析する場合は**生データを転送する**だけでもOK。  
   - 送信データ量やモジュール処理負荷とのバランスを考慮し、どこまで推定するかを選択。

### 2.2. データ転送機能（Bluetooth）

1. **Bluetooth Low Energy (BLE) 通信（必須）**  
   - M5モジュールがペリフェラル（Peripheral）として動作し、スマートフォンと接続。  
   - キャラクタリスティックNotifyで **(a) 生データ**、または **(b) 推定したBPM** を定期送信。  
   - 転送周期はセンサ計測と同等もしくは数秒ごとの集計値でも可。  

2. **再接続・通信安定性（推奨）**  
   - 接続が切れた際の再接続処理や通信ステータスの監視。  
   - 短時間の実験ならそれほど問題になりにくいが、長時間の場合は安定運用を考慮。

### 2.3. バッテリ駆動・消費電力

1. **バッテリ動作（必須）**  
   - M5StickC Plus 2 内蔵バッテリで数時間の稼働を想定。  
   - 実験時間が2～3時間程度なら内蔵バッテリでも運用可能。  
   - 長時間の場合はモバイルバッテリやUSB給電を併用し、足首付近でケーブルの取り回しに注意。

2. **省電力設計（推奨）**  
   - 不要なWi-Fiや高負荷処理は停止し、BLE計測・送信のみ実行して消費電力を抑える。  
   - センササンプリングを必要最小限にすることでバッテリ持続時間を延ばす。

### 2.4. 筐体・装着性

1. **足首装着**  
   - 面ファスナーベルトやスポーツバンドを使い、しっかり固定しても圧迫しすぎない。  
   - なるべく小型・軽量で、歩行時にぶれないようにする。  
2. **耐候性・衝撃吸収（任意）**  
   - 軽い防水・防塵対策や衝撃対策が必要なら、ケースを改造または3Dプリントでカバーを作成。

---

## 3. スマートフォン側（参考）

- **音刺激提示、制御アルゴリズム、ログ記録**などはスマートフォンアプリで実施。  
- M5モジュールから受信したBPMや生データを基に解析する。  
- テンポをリアルタイムで変化させる場合は、スマートフォン側で音を再生し、被験者がイヤホンやスピーカーで聴く。  

---

## 4. 非機能要件

### 4.1. 信頼性・安定性

- **通信安定性**: BLE接続が途切れにくいよう、ペアリング時や距離の取り方に注意。  
- **障害時のリカバリ**: バッテリ切れやセンサ故障が起きた際に、アプリで検知しやすいようにエラーステータスを通知。  

### 4.2. レスポンス性能

- **リアルタイム性**: 歩行ピッチ推定結果を1～2秒以内の遅延でスマホに送る程度で十分。  
- **処理負荷**: M5側の演算を最小限に留めれば、50Hz程度で生データ取得・BLE送信を問題なく行える。  

### 4.3. ユーザビリティ

- **装着容易性**: 被験者が足首バンドを一人で装着できるシンプル構造。  
- **操作性**: 1～2個のボタンで電源ON/OFF、計測開始/停止ができればよい。 スマホ側からのリモート制御も検討可。  

### 4.4. 拡張性

- **他センサ連携**: 心拍センサや筋電センサを同時運用する場合、M5の拡張Groveポート等を使用するか、別デバイスで計測してスマホ側で統合する。  
- **ファームウェアアップデート**: BLEかUSB経由で更新できるようにしておくと、研究内容が拡張された際に対応が容易。  

---

## 5. 運用フロー（例）

1. **バンド・モジュール装着**  
   - 被験者の足首にM5モジュールを取り付ける。  
   - 電源をONし、LEDや画面表示で起動確認。  
2. **スマホアプリと接続**  
   - アプリ側でBLEスキャン → M5モジュールとペアリング。  
   - データ受信（Notify）が開始され、加速度or推定BPMを取得。  
3. **歩行開始 / データ送信**  
   - 被験者がウォーキングを始めると、M5モジュールはセンサ値or BPMをリアルタイムで送信。  
   - スマホ側で音刺激を生成し、歩行テンポに応じてテンポを制御。  
4. **実験終了**  
   - スマホ側で記録停止 → M5モジュール側で計測停止。  
   - 電源OFF、バンドを外す。  

---

## 6. 今後の検討事項

1. **歩行ピッチのどのレベルまでM5モジュール側で演算するか**  
   - 完全に生データだけ送ってスマホで解析するか、簡易なピーク検出をモジュール側で行うかを検討。  
2. **ログの保存場所**  
   - ログはスマホアプリで一括管理する方が一般的。M5側には残さず、転送後に削除でもよい。  
3. **電源対策**  
   - 長時間利用が必要なら、USBケーブルや外付けバッテリを装着する構造を考慮。  
4. **屋外実験時の通信範囲**  
   - BLEの通信範囲は数m～10m程度を想定。被験者とスマホが離れすぎないように運用。  

---

# まとめ

- **M5モジュール**は足首装着センサとして、「歩行ピッチ（BPM）の推定／または生データの送信」と「BLE通信」に特化した設計とする。  
- **音の再生やテンポ制御ロジックはスマートフォン側で実行**することで、M5モジュールは計測・転送に専念でき、バッテリや処理負荷を抑えられる。  
- 必要な機能がシンプルになる分、開発・運用が容易となり、研究の拡張性（複数センサ連携、スマホアプリ解析強化）も確保しやすい。  

以上の要件により、最小限のハードウェア構成とソフトウェア機能で**足首モジュール×スマホアプリ**の連携が実現できる見込みです。